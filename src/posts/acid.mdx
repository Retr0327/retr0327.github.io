---
title: ACID 基礎觀念
createdAt: '2023-01-29'
updatedAt: '2023-02-05'
excerpt: 這篇想要紀錄的是在學關聯式資料庫（Relational Database Management System, RDDMS）或是面試中很常會碰到的專有名詞 —— ACID。
slug: '/blog/p/acid'
category: ['RDBMS']
coverImage: 'https://clockwise.software/img/blog/relational-vs-non-relational-databases-advantages-and-disadvantages/header-background.jpg'
---

ACID 原則是 RDBMS 中 transaction (資料庫交易)[^1] 的特性，本篇我們將以 PostgreSQL 來當作例子。四個英文字母分別為
Atomicity (原子性)、Consistency (一致性)、Isolation (隔離性)、Durability (持續性)。

[^1]: Transaction (資料庫交易) 是 RDBMS 中一組一連串的操作（由各種資料庫語法 SELECT、INSERT 等所組成），且必須滿足 ACID 的特性。

## Atomicity (原子性)

### 定義

指的是一個 transaction 中的所有操作如果如果沒有錯誤，就全部 commit；反之，只要有一個錯誤（網路問題、當機等），就全部 rollback (回復)。[^2]

[^2]: 會叫「原子性」是因為在化學中，原子是最小且不可分割的結構。如同 RDBMS 中的 transaction 一樣，要麽全部 commit (確認)，要麼全部 rollback (回覆)。

### 目的

為了確保它資料庫中數據的「**一致性**」，因為我們不能保證在做資料更改的當下，資料庫不會遇上不可預期的錯誤。當資料庫重啟後，資料必須要是正確的，且不能有數據錯誤的問題產生。

### 舉例

假設用戶 A 要匯錢給一個用戶 B：

```sql
BEGIN;
UPDATE user SET balance = balance - amount WHERE username = 'UserA' AND balance >= amount;
UPDATE user SET balance = balance + amount WHERE username = 'UserB';
COMMIT;
```

如果沒有 Atomicity，當第一句的 `UPDATE` 成功，而第二句的 `UPDATE`失敗，會導致 `UserA` 錢減少了，但
`UserB` 的錢卻沒有相對應的增加。

因此 Atomicity 保證資料庫的數據能夠從一個正確狀態直接移到下一個正確狀態。

## Consistency (一致性)

### 定義

在 transaction 成功 commit 後，資料改動必須滿足 unique constraint 和用戶自定義 constraint，像是一些 FK
跟資料欄位型態的限制。只要沒有遵守，就全部 rollback。

### 目的

確保資料庫中的數據滿足所有 unique constraint 和自定義的 constraint，並符合預期的業務規則。

### 舉例

```sql
CREATE TABLE user (
    id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    email TEXT NOT NULL UNIQUE
);

INSERT INTO user (email) VALUES ('1@mail.com');
INSERT INTO user (email) VALUES ('1@mail.com');
```

如果沒有 Consistency，我們就會在 `user` 中 `INSERT`
重複的數據，可能會導致很多不可預期的錯誤，像是數據不一致或是數據超過開發者所設下的限制等等。

因此 Consistency 保證資料庫數據的改動能夠遵守限制，transaction 才能成功 commit。

## Isolation (隔離性)

### 定義

指的是多個 transactions 之間相互隔離，不能互相影響。Isolation 有分好幾種等級，以下是**由低到高**：

- read uncommitted (讀取未提交數據): transaction 可以讀取其他 transactions 未提交的數據 → 可能會讀取到不一致的數據
- read commited (讀取已提交數據): transaction 只能讀取已經提交的數據
- repeatable read (可重複讀取): transaction 在開始時鎖定了讀取的數據，以防止其他交易修改
- serializable (可序列化): transactions 之間是完全隔離的，它們之間不能有任何干擾

在最低等級是會導致 race condition，最高等級則不會有，但是其效能會大幅度降低。

> 有些帳戶操作的系統之所以慢，是因為需要高度隔離而使效能降低

### 目的

避免 race condition 的情況發生。

### 舉例

以用戶提款為例：

```sql
-- session 1
BEGIN;
UPDATE user SET balance = balance - amount WHERE username = 'UserA' AND balance >= amount;
COMMIT;

-- session 2
BEGIN;
UPDATE user SET balance = balance + amount WHERE username = 'UserA';
COMMIT;
```

如果有 isolation 的 LOCK 機制，在 session 1 執行 `UPDATE` 時，RDBMS 會為 `UPDATE` 會影響的數據進行 Write
Lock，也就是該 `UserA` 的帳戶被凍結一樣，其他人不能對 `UserA` 的帳戶進行匯款或提款等動作，也就是 session 2 會無法進行。

## Durability (持續性)

### 定義

只要儲存硬體沒有受損，commited transaction 的數據會**永久**保存到磁碟上。為了確保資料的持久性，postgresql 使用了 Write-Ahead Logging (WAL)[^3] 機制。這意味著在寫入數據之前，postgresql
會先將更改記錄到 WAL 檔案中，確保即使發生意外，資料仍然可以從 WAL 恢復。舉個例子，假設你有一個銀行帳戶，並且你想要從這個帳戶中存入
$100。當你執行存款操作時，WAL 會首先將這個操作記錄到日誌文件中，然後再將 $100 加到你的帳戶中。如果在這個過程中發生了任何問題，例如系統故障或停電，那麼可以使用日誌文件來恢復帳戶的狀態。WAL
的另一個優點是它可以實現資料庫的讀寫分離。因為 WAL 已經記錄了所有的更改，所以可以在寫入資料時讀取資料。這使得資料庫可以同時實現高效讀取和寫入。

[^3]: Write-Ahead Logging (WAL) 是一種事務記錄方法，它會在寫入數據之前將更改記錄到一個日誌文件中。這樣可以確保即使發生系統故障，資料仍然可以從日誌文件中恢復

### 目的

確保 commited transaction 的數據將永久保存在資料庫中。

## 總結

| <div style={{ width: 125 }}>Atomicity (原子性)</div> | <div style={{ width: 150 }}>Consistency (一致性)</div> | <div style={{ width: 125 }}>Isolation (隔離性)</div> | <div style={{ width: 125 }}>Durability (持久性)</div> |
| ---------------------------------------------------- | ------------------------------------------------------ | ---------------------------------------------------- | ----------------------------------------------------- |
| 確保數據的一致性                                     | 數據更改需滿足所有限制                                 | 避免 race condition                                  | 確保 commited transaction 的數據永久保存              |

#### 參考資料

1. [RDBMS (關聯式資料庫) - ACID 基礎觀念](https://blog.kennycoder.io/2020/01/21/RDBMS-%E9%97%9C%E8%81%AF%E5%BC%8F%E8%B3%87%E6%96%99%E5%BA%AB-ACID%E5%9F%BA%E7%A4%8E%E8%A7%80%E5%BF%B5/)
2. [│ 資料庫 │ 淺談關聯式資料庫與 ACID 特性](https://medium.com/appxtech/%E8%B3%87%E6%96%99%E5%BA%AB-%E6%B7%BA%E8%AB%87%E9%97%9C%E8%81%AF%E5%BC%8F%E8%B3%87%E6%96%99%E5%BA%AB%E8%88%87acid%E7%89%B9%E6%80%A7-83a1b4178981)
3. [TritonHo slides](https://github.com/TritonHo/slides)
4. [Database Transaction & ACID](https://oldmo860617.medium.com/database-transaction-acid-156a3b75845e)
